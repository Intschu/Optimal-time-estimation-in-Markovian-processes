Selected code used in https://journals.aps.org/prx/abstract/10.1103/rpls-mp8z
